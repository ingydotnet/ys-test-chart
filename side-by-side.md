### Side by Side File Comparisons

_Generated by [`sbs`](
https://github.com/ingydotnet/sbs/tree/main/bin/sbs) (a [YAMLScript](
https://yamlscript.org/) program)._

----
<table>
<tr><td>`charts/yamlscript/helpers.ys`</td><td>`orig/templates/_helpers.tpl`</td></tr>
<tr><td>

```ys
!yamlscript/v0

# Load the 3 main Helm data sources into variables:
Chart =: yaml/load-file('Chart.yaml')
Values =: yaml/load-file('values.yaml')

# The 'Release' data is built into Helm but we can get it here by rendering a
# little template that formats it as YAMLScript:
Release =: sh('helm template -s templates/helm-data.yaml charts/yamlscript')
  .out:eval:var-get.Release

# Define 2 trunc funcs:
defn trunc(s): take(63 s).str(*).replace(/-$/)
defn trunc+(s): s:trunc.replace(/\+/ '_')

# Expand the name of the chart:
chart-name =: trunc(Values.nameOverride ||| Chart.name)

# Create a default fully qualified app name.
# We truncate at 63 chars because some Kubernetes name fields are limited to
# this (by the DNS naming spec).
# If release name contains chart name it will be used as a full name.
defn chart-fullname():
  if Values.fullnameOverride.?:
    then: Values.fullnameOverride:trunc
    else:
      name =: Values.nameOverride ||| Chart.name
      if name.has?(Release.Name):
        trunc: Release.Name
        format "%s-%s": Release.Name name

# Create chart name and version as used by the chart label:
defn chart-chart():
  trunc+: format("%s-%s" Chart.Name Chart.Version)

# Common labels:
defn common-labels():
  apply merge::
  - helm.sh/chart:: "$(Chart.name)-$(Chart.version)"
  - ! selectorLabels()
  - app.kubernetes.io/version:: Chart.appVersion
    app.kubernetes.io/managed-by:: Release.Service

# Selector labels:
defn selectorLabels()::
  app.kubernetes.io/name:: Chart.name
  app.kubernetes.io/instance:: Release.Name

# Create the name of the service account to use:
defn serviceAccountName():
  "release-name-$chart-name"












```

</td><td>

```tpl
{{/*
Expand the name of the chart.
*/}}
{{- define "ys-test-chart.name" -}}
{{- default .Chart.Name .Values.nameOverride | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Create a default fully qualified app name.
We truncate at 63 chars because some Kubernetes name fields are limited to this (by the DNS naming spec).
If release name contains chart name it will be used as a full name.
*/}}
{{- define "ys-test-chart.fullname" -}}
{{- if .Values.fullnameOverride }}
{{- .Values.fullnameOverride | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- $name := default .Chart.Name .Values.nameOverride }}
{{- if contains $name .Release.Name }}
{{- .Release.Name | trunc 63 | trimSuffix "-" }}
{{- else }}
{{- printf "%s-%s" .Release.Name $name | trunc 63 | trimSuffix "-" }}
{{- end }}
{{- end }}
{{- end }}

{{/*
Create chart name and version as used by the chart label.
*/}}
{{- define "ys-test-chart.chart" -}}
{{- printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 | trimSuffix "-" }}
{{- end }}

{{/*
Common labels
*/}}
{{- define "ys-test-chart.labels" -}}
helm.sh/chart: {{ include "ys-test-chart.chart" . }}
{{ include "ys-test-chart.selectorLabels" . }}
{{- if .Chart.AppVersion }}
app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
{{- end }}
app.kubernetes.io/managed-by: {{ .Release.Service }}
{{- end }}

{{/*
Selector labels
*/}}
{{- define "ys-test-chart.selectorLabels" -}}
app.kubernetes.io/name: {{ include "ys-test-chart.name" . }}
app.kubernetes.io/instance: {{ .Release.Name }}
{{- end }}

{{/*
Create the name of the service account to use
*/}}
{{- define "ys-test-chart.serviceAccountName" -}}
{{- if .Values.serviceAccount.create }}
{{- default (include "ys-test-chart.fullname" .) .Values.serviceAccount.name }}
{{- else }}
{{- default "default" .Values.serviceAccount.name }}
{{- end }}
{{- end }}
```

</td></tr>
</table>

----
<table>
<tr><td>`templates/serviceaccount.yaml`</td><td>`orig/templates/serviceaccount.yaml`</td></tr>
<tr><td>

```yaml
!yamlscript/v0/
::
  use: helpers

apiVersion: v1
kind: ServiceAccount
metadata:
  name:: serviceAccountName()
  labels:: common-labels()
  ::
    when Values.serviceAccount.annotations.?::
      annotations:: Values.serviceAccount.annotations
automountServiceAccountToken::
  Values.serviceAccount.automount
```

</td><td>

```yaml
{{- if .Values.serviceAccount.create -}}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "ys-test-chart.serviceAccountName" . }}
  labels:
    {{- include "ys-test-chart.labels" . | nindent 4 }}
  {{- with .Values.serviceAccount.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
automountServiceAccountToken: {{ .Values.serviceAccount.automount }}
{{- end }}


```

</td></tr>
</table>

----
<table>
<tr><td>`templates/service.yaml`</td><td>`orig/templates/service.yaml`</td></tr>
<tr><td>

```yaml
!yamlscript/v0/

apiVersion: v1
kind: Service
metadata:
  name:: chart-fullname()
  labels:: common-labels()
spec:
  type:: Values.service.type
  ports:
  - port:: Values.service.port
    targetPort: http
    protocol: TCP
    name: http
  selector:: selectorLabels()
```

</td><td>

```yaml
apiVersion: v1
kind: Service
metadata:
  name: {{ include "ys-test-chart.fullname" . }}
  labels:
    {{- include "ys-test-chart.labels" . | nindent 4 }}
spec:
  type: {{ .Values.service.type }}
  ports:
    - port: {{ .Values.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "ys-test-chart.selectorLabels" . | nindent 4 }}
```

</td></tr>
</table>

----
<table>
<tr><td>`templates/deployment.yaml`</td><td>`orig/templates/deployment.yaml`</td></tr>
<tr><td>

```yaml
--- !yamlscript/v0/

apiVersion: apps/v1
kind: Deployment
metadata:
  name:: chart-fullname()
  labels:: common-labels()
spec:
  ::
    when-not Values.autoscaling.enabled.?::
      replicas:: Values.replicaCount
  selector:
    matchLabels:: selectorLabels()
  template:
    metadata:
      ::
        when Values.podAnnotations.?::
          annotations:: Values.podAnnotations
      labels:: common-labels()
    spec:
      ::
        when Values.imagePullSecrets.?::
          imagePullSecrets:: Values.imagePullSecrets
      serviceAccountName:: serviceAccountName()
      securityContext:: Values.podSecurityContext
      containers:
      - name:: Chart.name
        securityContext:: Values.securityContext
        image:: "$(Values.image.repository):\
                 $(Values.image.tag ||| Chart.appVersion)"
        imagePullPolicy:: Values.image.pullPolicy
        ports:
        - name: http
          containerPort:: Values.service.port
          protocol: TCP
        livenessProbe:: Values.livenessProbe
        readinessProbe:: Values.readinessProbe
        resources:: Values.resources
        ::
          when Values.volumeMounts.?::
            volumeMounts:: Values.volumeMounts
      ::
        when Values.volumes.?::
          volumes:: Values.volumes
      ::
        when Values.nodeSelector.?::
          nodeSelector:: Values.nodeSelector
      ::
        when Values.affinity.?::
          affinity:: Values.affinity
      ::
        when Values.tolerations.?::
          tolerations:: Values.tolerations
















```

</td><td>

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "ys-test-chart.fullname" . }}
  labels:
    {{- include "ys-test-chart.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "ys-test-chart.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "ys-test-chart.labels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "ys-test-chart.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          livenessProbe:
            {{- toYaml .Values.livenessProbe | nindent 12 }}
          readinessProbe:
            {{- toYaml .Values.readinessProbe | nindent 12 }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          {{- with .Values.volumeMounts }}
          volumeMounts:
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- with .Values.volumes }}
      volumes:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
```

</td></tr>
</table>

----
<table>
<tr><td>`templates/tests/test-connection.yaml`</td><td>`orig/templates/tests/test-connection.yaml`</td></tr>
<tr><td>

```yaml
!yamlscript/v0/

apiVersion: v1
kind: Pod
metadata:
  name:: "$chart-fullname()-test-connection"
  labels:: common-labels()
  annotations:
    helm.sh/hook: test
spec:
  containers:
  - name: wget
    image: busybox
    command: ['wget']
    args:
    - ! "$chart-fullname():$(Values.service.port)"
  restartPolicy: Never
```

</td><td>

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "ys-test-chart.fullname" . }}-test-connection"
  labels:
    {{- include "ys-test-chart.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['{{ include "ys-test-chart.fullname" . }}:{{ .Values.service.port }}']
  restartPolicy: Never



```

</td></tr>
</table>
